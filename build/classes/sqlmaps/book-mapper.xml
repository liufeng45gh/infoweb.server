<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lucifer.model">

  <insert id="insertBook">
  	insert into book (id,c_id,name,cover,intro,author,book.sensitive,visible,catogry,updated_at) values (#{id},#{c_id},#{name},#{cover},#{intro},#{author},#{sensitive},0,#{catogry},#{updated_at})
  </insert>
  
  <select id="cmsSearchBookList" resultType="com.lucifer.model.Book">
  	<![CDATA[
  	select * from book where visible<2
  	]]>
 	<if test="c_id != null and c_id != '' ">
	and c_id like '${c_id}%'
	</if>
	<if test="sensitive != null">
	and book.sensitive = #{sensitive}
	</if>
	<if test="status != null">
	and status = #{status}
	</if>
	<if test="catogry != null and catogry != '' ">
	and book.catogry = #{catogry}
	</if>
	<if test="name != null and name != '' ">
	and name like '${name}%'
	</if> 
	order by id desc
	<if test="offset != null and perPageCount != null">
	limit #{offset},#{perPageCount}
	</if> 
   
  </select>
  <select id="cmsSearchBookMatchCount" resultType="java.lang.Integer">
  	<![CDATA[
  	select count(*) from book where visible<2
  	]]>
  	<if test="c_id != null and c_id != '' ">
	and c_id like '${c_id}%'
	</if>
	<if test="sensitive != null">
	and book.sensitive = #{sensitive}
	</if>
	<if test="status != null">
	and status = #{status}
	</if>
	<if test="catogry != null and catogry != '' ">
	and book.catogry = #{catogry}
	</if>
	<if test="name != null and name != '' ">
	and name like '${name}%'
	</if> 
  </select>
  <select id="getBook" resultType="com.lucifer.model.Book">
  	select * from book where id = #{id}
  </select>
  
  
  <update id="updateBook">
  update book
  <trim prefix="SET" suffixOverrides=",">
	<if test="c_id != null and c_id != '' ">  
		c_id=#{c_id},
	</if>
	<if test="name != null and name != '' ">  
		name=#{name},
	</if>
	<if test="cover != null and cover != '' ">  
		cover=#{cover},
	</if>
	<if test="intro != null and intro != '' ">  
		intro=#{intro},
	</if>
	<if test="author != null and author != '' ">  
		author=#{author},
	</if>
	<if test="sensitive != null and sensitive != '' ">  
		book.sensitive=#{sensitive},
	</if>
	<if test="catogry != null and catogry != '' ">
		book.catogry=#{catogry},
	</if>
	<if test="appendix != null and appendix != '' ">
		book.appendix=#{appendix}
	</if>
	<if test="updated_at != null and updated_at != '' ">
		book.updated_at=#{updated_at}
	</if>
  </trim>
  where id =#{id}
  </update>
  <delete id="deleteBook">
  update book set visible = 2 where id = #{id}
  </delete>
  
  
  <!-- init list -->
  <select id="initBookList" resultType="com.lucifer.model.Book">
  	select book.* from init_book left outer join book on init_book.b_id=book.id order by init_book.id desc
  </select>
  <delete id="deleteInitBook">
  delete from init_book where b_id = #{id}
  </delete>
  <insert id="insertToInit">
  insert into init_book (id,b_id) values (#{id},#{b_id})
  </insert>
  
  <update id="updateBookDownLoadFile">
  	update book
		 <trim prefix="SET" suffixOverrides=",">	
			<if test="down_file != null and down_file != '' ">
				book.down_file=#{down_file},
			</if>
			<if test="status != null and status != '' ">
				book.status=#{status}
			</if>
		 </trim>
  	where id =#{id}
  </update>
  <update id="updateBookAppendix">
  	update book set book.appendix = #{appendix} where id=#{id}
  </update>
  <update id="updataBookDownloadCount">
  	update book set download_count = #{download_count} where id=#{id}
  </update>
  
  <!-- chapter -->
  
  <insert id="insertChapter" parameterType="com.lucifer.model.Chapter">
	  <![CDATA[
	  	insert into 
	  		chapter (id,book_id,title,content,position,type,visible) 
	  	select 
	  		#{id},#{book_id},#{title},#{content}, coalesce(max(position),0)+1,#{type},0 
	  	from 
	  		chapter 
	  	where 
	  		book_id = #{book_id}
	  	and
	  		visible<2
	  	]]>
  </insert>
  
  <select id="findChaptersByID" resultType="com.lucifer.model.Chapter">
  	<![CDATA[
  	select * from chapter where visible<2 and book_id = #{book_id} order by position desc
  	]]>
  </select>
  
  <delete id="deleteChapter">
  update chapter set visible = 2 where id = #{id}
  </delete>
  
  <select id="findChapter" resultType="com.lucifer.model.Chapter">
  	<![CDATA[
  	select * from chapter where visible<2 and id = #{id}
  	]]>
  </select>
  
  <update id="updateChapter">
  update chapter set title=#{title},content=#{content} where id =#{id}
  </update>
  <select id="capterCount" resultType="java.lang.Integer">
  	select count(*) from chapter where book_id=#{book_id} and visible!=2
  </select>
  
  <select id="bookChannelList" resultType="com.lucifer.model.BookChannel">
  	select b.b_id,b.c_id,c.name from book_channel b , channel c where b.c_id =c.id and b.b_id=#{b_id}
  </select>
  
  <insert id="insertBookChannel">
  	insert into book_channel (b_id,c_id) values (#{b_id},#{c_id})
  </insert>
  
  <delete id="delBookChannel">
  	delete from book_channel where b_id = #{b_id} and c_id = #{c_id}
  </delete>
  
  <update id="updateChapterPosition">
  update chapter set position=#{position} where id =#{id}
  </update>
  
  <!-- classification -->
  
  <insert id="insertBookClass">
  	insert into book_classification(b_id,c_id) values (#{b_id},#{c_id})
  </insert>
  
  <select id="bookClassList" resultType="com.lucifer.model.BookClass">
  	select b.b_id,b.c_id,c.name from book_classification b , classification c where b.c_id =c.id and b.b_id=#{id}
  </select>
  
  <delete id="delBookClass">
  	delete from book_classification where b_id = #{b_id} and c_id = #{c_id}
  </delete>
  
  <select id="getByAuthor" resultType="com.lucifer.model.Book">
  	<![CDATA[
  	select * from book where visible<2 and id != #{id} and author = #{author} limit 6
  	]]>
  </select>
  
</mapper>